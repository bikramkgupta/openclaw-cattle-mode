# Container test (smoke or full backup/restore) and optional deploy to App Platform.
#
# Required secrets for container test: AGENT_ID, OPENCLAW_GATEWAY_TOKEN
# Optional (for full E2E): GRADIENT_API_KEY
#   - If GRADIENT_API_KEY is set → runs test-backup.sh (Spaces/backup/restore via local RustFS)
#   - Otherwise → runs smoke-boot.sh (container boots, health check passes)
# NOTE: Telegram is intentionally excluded from CI tests to avoid conflicting
#   with the production bot (Telegram allows only one poller per token).
#
# For deploy job: set run_deploy when triggering; requires DIGITALOCEAN_TOKEN and all
# .env.remote vars (see DEPLOYMENT.md) as GitHub secrets.

name: Integration

on:
  schedule:
    - cron: "0 8 * * *"   # 12 AM Pacific / 8 AM UTC (1h after nightly)
  workflow_dispatch:
    inputs:
      run_deploy:
        description: 'Run deploy to App Platform (requires DIGITALOCEAN_TOKEN + .env.remote secrets)'
        required: false
        default: false
        type: boolean

env:
  PROJECT_DIR: ${{ github.workspace }}

jobs:
  deploy-spec:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext-base
      - name: Test deploy spec render
        run: bash scripts/test-deploy-spec.sh

  container-test:
    runs-on: ubuntu-latest
    needs: deploy-spec
    steps:
      - uses: actions/checkout@v4

      - name: Create .env.docker
        env:
          GRADIENT_API_KEY: ${{ secrets.GRADIENT_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AGENT_DEFAULT_MODEL: ${{ secrets.AGENT_DEFAULT_MODEL }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AGENT_NAME: ${{ secrets.AGENT_NAME || 'OpenClaw CI Agent' }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
        run: |
          sanitize() { printf '%s' "$1" | tr -d '\n\r'; }
          {
            IMAGE_TAG=$(grep -oP 'ARG OPENCLAW_VERSION=\K.*' openclaw-agent-image/Dockerfile)
            echo "IMAGE_TAG=${IMAGE_TAG}"
            printf 'GRADIENT_API_KEY=%s\n' "$(sanitize "$GRADIENT_API_KEY")"
            printf 'OPENAI_API_KEY=%s\n' "$(sanitize "$OPENAI_API_KEY")"
            printf 'ANTHROPIC_API_KEY=%s\n' "$(sanitize "$ANTHROPIC_API_KEY")"
            printf 'AGENT_DEFAULT_MODEL=%s\n' "$(sanitize "$AGENT_DEFAULT_MODEL")"
            printf 'AGENT_ID=%s\n' "$(sanitize "$AGENT_ID")"
            printf 'AGENT_NAME=%s\n' "$(sanitize "$AGENT_NAME")"
            printf 'OPENCLAW_GATEWAY_TOKEN=%s\n' "$(sanitize "$OPENCLAW_GATEWAY_TOKEN")"
            echo "SPACES_BUCKET=openclaw-dev"
            echo "SPACES_REGION=us-east-1"
            echo "SPACES_ACCESS_KEY_ID=rustfsadmin"
            echo "SPACES_SECRET_ACCESS_KEY=rustfsadmin"
            echo "S3_ENDPOINT_URL=http://rustfs:9000"
            echo "RUSTFS_IMAGE=rustfs/rustfs:1.0.0-alpha.82"
          } > .env.docker

      - name: Validate .env.docker
        run: |
          dupes=$(awk -F= 'NF>1 && $1!="" {print $1}' .env.docker | sort | uniq -d)
          if [[ -n "$dupes" ]]; then
            echo "::error::Duplicate keys in .env.docker: $dupes"
            exit 1
          fi
          bucket=$(grep '^SPACES_BUCKET=' .env.docker | cut -d= -f2-)
          if [[ "$bucket" != "openclaw-dev" ]]; then
            echo "::error::SPACES_BUCKET must be 'openclaw-dev' in CI, got: $bucket"
            exit 1
          fi
          echo ".env.docker validated ($(wc -l < .env.docker) lines, no duplicates)"

      - name: Decide smoke vs full E2E
        id: mode
        run: |
          # Full E2E when Gradient secret is non-empty (Telegram intentionally excluded)
          if grep -qE '^GRADIENT_API_KEY=.+' .env.docker 2>/dev/null; then
            echo "run_full=true" >> $GITHUB_OUTPUT
            echo "Running full E2E (backup/restore)"
          else
            echo "run_full=false" >> $GITHUB_OUTPUT
            echo "Running smoke only (container boot)"
          fi
      - name: Run smoke (container boot)
        if: steps.mode.outputs.run_full == 'false'
        run: bash scripts/smoke-boot.sh

      - name: Run full E2E (backup/restore)
        if: steps.mode.outputs.run_full == 'true'
        run: bash scripts/test-backup.sh

  deploy:
    runs-on: ubuntu-latest
    needs: [deploy-spec, container-test]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl and envsubst
        run: |
          sudo apt-get update && sudo apt-get install -y gettext-base
          curl -sL https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz | sudo tar -xzf - -C /usr/local/bin

      - name: Create .env.remote
        env:
          IMAGE_TAG: ${{ secrets.IMAGE_TAG }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AGENT_NAME: ${{ secrets.AGENT_NAME }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ALLOWFROM: ${{ secrets.TELEGRAM_ALLOWFROM }}
          WHATSAPP_ALLOWFROM: ${{ secrets.WHATSAPP_ALLOWFROM }}
          GRADIENT_API_KEY: ${{ secrets.GRADIENT_API_KEY }}
          AGENT_DEFAULT_MODEL: ${{ secrets.AGENT_DEFAULT_MODEL }}
          NODE_OPTIONS: ${{ secrets.NODE_OPTIONS || '--max-old-space-size=768' }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          SPACES_BUCKET: ${{ secrets.SPACES_BUCKET }}
          SPACES_REGION: ${{ secrets.SPACES_REGION }}
          SPACES_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY_ID }}
          SPACES_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_ACCESS_KEY }}
        run: |
          # Fall back to Dockerfile version if IMAGE_TAG secret is not set
          if [[ -z "${IMAGE_TAG}" ]]; then
            IMAGE_TAG=$(grep -oP 'ARG OPENCLAW_VERSION=\K.*' openclaw-agent-image/Dockerfile)
            echo "IMAGE_TAG not set in secrets, using Dockerfile version: ${IMAGE_TAG}"
          fi
          sanitize() { printf '%s' "$1" | tr -d '\n\r'; }
          {
            printf 'IMAGE_TAG=%s\n' "$(sanitize "$IMAGE_TAG")"
            printf 'AGENT_ID=%s\n' "$(sanitize "$AGENT_ID")"
            printf 'AGENT_NAME=%s\n' "$(sanitize "$AGENT_NAME")"
            printf 'TELEGRAM_BOT_TOKEN=%s\n' "$(sanitize "$TELEGRAM_BOT_TOKEN")"
            printf 'TELEGRAM_ALLOWFROM=%s\n' "$(sanitize "$TELEGRAM_ALLOWFROM")"
            printf 'WHATSAPP_ALLOWFROM=%s\n' "$(sanitize "$WHATSAPP_ALLOWFROM")"
            printf 'GRADIENT_API_KEY=%s\n' "$(sanitize "$GRADIENT_API_KEY")"
            printf 'AGENT_DEFAULT_MODEL=%s\n' "$(sanitize "$AGENT_DEFAULT_MODEL")"
            printf 'NODE_OPTIONS=%s\n' "$(sanitize "$NODE_OPTIONS")"
            printf 'OPENCLAW_GATEWAY_TOKEN=%s\n' "$(sanitize "$OPENCLAW_GATEWAY_TOKEN")"
            printf 'SPACES_BUCKET=%s\n' "$(sanitize "$SPACES_BUCKET")"
            printf 'SPACES_REGION=%s\n' "$(sanitize "$SPACES_REGION")"
            printf 'SPACES_ACCESS_KEY_ID=%s\n' "$(sanitize "$SPACES_ACCESS_KEY_ID")"
            printf 'SPACES_SECRET_ACCESS_KEY=%s\n' "$(sanitize "$SPACES_SECRET_ACCESS_KEY")"
          } > .env.remote

      - name: Deploy to App Platform
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: bash scripts/deploy.sh
