# Container test (smoke or full backup/restore) and optional deploy to App Platform.
#
# Required secrets for container test: AGENT_ID, OPENCLAW_GATEWAY_TOKEN
# Optional (for full E2E): GRADIENT_API_KEY
#   - If GRADIENT_API_KEY is set → runs test-backup.sh (Spaces/backup/restore via local RustFS)
#   - Otherwise → runs smoke-boot.sh (container boots, health check passes)
# NOTE: Telegram is intentionally excluded from CI tests to avoid conflicting
#   with the production bot (Telegram allows only one poller per token).
#
# For deploy job: set run_deploy when triggering; requires DIGITALOCEAN_TOKEN and all
# .env.remote vars (see DEPLOYMENT.md) as GitHub secrets.

name: Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_deploy:
        description: 'Run deploy to App Platform (requires DIGITALOCEAN_TOKEN + .env.remote secrets)'
        required: false
        default: false
        type: boolean

env:
  PROJECT_DIR: ${{ github.workspace }}

jobs:
  deploy-spec:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext-base
      - name: Test deploy spec render
        run: bash scripts/test-deploy-spec.sh

  container-test:
    runs-on: ubuntu-latest
    needs: deploy-spec
    steps:
      - uses: actions/checkout@v4

      - name: Create .env.docker
        run: |
          cat << 'ENVFILE' > .env.docker
          IMAGE_TAG=2026.2.12
          GRADIENT_API_KEY=${{ secrets.GRADIENT_API_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          AGENT_DEFAULT_MODEL=${{ secrets.AGENT_DEFAULT_MODEL }}
          AGENT_ID=${{ secrets.AGENT_ID }}
          AGENT_NAME=${{ secrets.AGENT_NAME || 'OpenClaw CI Agent' }}
          OPENCLAW_GATEWAY_TOKEN=${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          SPACES_BUCKET=openclaw-dev
          SPACES_REGION=us-east-1
          SPACES_ACCESS_KEY_ID=rustfsadmin
          SPACES_SECRET_ACCESS_KEY=rustfsadmin
          S3_ENDPOINT_URL=http://rustfs:9000
          RUSTFS_IMAGE=rustfs/rustfs:1.0.0-alpha.82
          ENVFILE

      - name: Decide smoke vs full E2E
        id: mode
        run: |
          # Full E2E when Gradient secret is non-empty (Telegram intentionally excluded)
          if grep -qE '^GRADIENT_API_KEY=.+' .env.docker 2>/dev/null; then
            echo "run_full=true" >> $GITHUB_OUTPUT
            echo "Running full E2E (backup/restore)"
          else
            echo "run_full=false" >> $GITHUB_OUTPUT
            echo "Running smoke only (container boot)"
          fi
      - name: Run smoke (container boot)
        if: steps.mode.outputs.run_full == 'false'
        run: bash scripts/smoke-boot.sh

      - name: Run full E2E (backup/restore)
        if: steps.mode.outputs.run_full == 'true'
        run: bash scripts/test-backup.sh

  deploy:
    runs-on: ubuntu-latest
    needs: [deploy-spec, container-test]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl and envsubst
        run: |
          sudo apt-get update && sudo apt-get install -y gettext-base
          curl -sL https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz | sudo tar -xzf - -C /usr/local/bin

      - name: Create .env.remote
        run: |
          cat << 'ENVFILE' > .env.remote
          IMAGE_TAG=${{ secrets.IMAGE_TAG || '2026.2.12' }}
          AGENT_ID=${{ secrets.AGENT_ID }}
          AGENT_NAME=${{ secrets.AGENT_NAME }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ALLOWFROM=${{ secrets.TELEGRAM_ALLOWFROM }}
          WHATSAPP_ALLOWFROM=${{ secrets.WHATSAPP_ALLOWFROM }}
          GRADIENT_API_KEY=${{ secrets.GRADIENT_API_KEY }}
          AGENT_DEFAULT_MODEL=${{ secrets.AGENT_DEFAULT_MODEL }}
          NODE_OPTIONS=${{ secrets.NODE_OPTIONS || '--max-old-space-size=768' }}
          OPENCLAW_GATEWAY_TOKEN=${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          SPACES_BUCKET=${{ secrets.SPACES_BUCKET }}
          SPACES_REGION=${{ secrets.SPACES_REGION }}
          SPACES_ACCESS_KEY_ID=${{ secrets.SPACES_ACCESS_KEY_ID }}
          SPACES_SECRET_ACCESS_KEY=${{ secrets.SPACES_SECRET_ACCESS_KEY }}
          ENVFILE

      - name: Deploy to App Platform
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: bash scripts/deploy.sh
